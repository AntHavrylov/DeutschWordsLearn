<section class="quiz-section" aria-labelledby="quiz-heading">
    <h2 id="quiz-heading">Quiz</h2>
    <div class="quiz-controls">
        <div class="quiz-list-selection">
            <label for="quiz-list-select">Wortliste auswählen:</label>
            <select id="quiz-list-select" class="form-control" [(ngModel)]="selectedListId">
                <option value="">Alle Wörter</option>
                <option *ngFor="let list of wordLists" [value]="list.id">{{ list.name }}</option>
            </select>
        </div>
        <button id="start-quiz-btn" class="btn btn-primary" (click)="startQuiz()">Neues Quiz starten</button>
    </div>

    <div *ngIf="noWordsMessage" class="error-message">{{ noWordsMessage }}</div>

    <div id="cards-container" role="region" aria-live="polite" *ngIf="quizService.session && !results">
        <div class="card" [ngClass]="{'correct': currentWord?.answer === true, 'incorrect': currentWord?.answer === false}">
            <ng-container *ngIf="currentWord">
                <div *ngIf="currentWord.isReverse; else standardQuestion">
                    <button id="i-know-btn" class="btn btn-success" (click)="iKnowThisWord()">Ich weiß es!</button>
                    <h2>{{ currentWord.translation }}</h2>

                    <!-- Guessing for Nouns (Level 3-7) -->
                    <ng-container *ngIf="currentWord.wordType === WordType.Noun">
                        <div class="article-quiz-options" *ngIf="currentWord.correctArticle && currentWord.correctArticle !== ArticleType.None && currentWord.correctArticle !== ArticleType.Ohne">
                            <button class="article-option-btn" *ngFor="let article of ['der', 'die', 'das']" [class.selected]="selectedArticle === article" (click)="selectArticle(article)">{{ article }}</button>
                        </div>
                        <div class="options">
                            <button *ngFor="let option of currentWord.options" class="option-btn" [class.selected]="selectedOption === option" (click)="selectOption(option)">{{ option }}</button>
                        </div>
                    </ng-container>

                    <!-- Guessing for Verbs (Level 3-7) -->
                    <ng-container *ngIf="currentWord.wordType === WordType.Verb">
                        <div class="article-quiz-options" *ngIf="currentWord.hiddenPart === 'preposition'">
                            <button class="preposition-option-btn" *ngFor="let prep of currentWord.prepositionOptions" [class.selected]="selectedPreposition === prep" (click)="selectPreposition(prep)">{{ prep }}</button>
                        </div>

                        <div class="options">
                            <button *ngFor="let option of currentWord.options" class="option-btn" [class.selected]="selectedOption === option" (click)="selectOption(option)">{{ option }}</button>
                        </div>

                        <div *ngIf="currentWord.hiddenPart === 'kasus'">
                            <h3>Kasus:</h3>
                            <button class="kasus-option-btn" *ngFor="let k of currentWord.kasusOptions" [class.selected]="selectedKasus === k" (click)="selectKasus(k)">{{ k }}</button>
                        </div>
                    </ng-container>

                    <!-- Guessing for other word types (Level 3-7) -->
                    <ng-container *ngIf="currentWord.wordType !== WordType.Noun && currentWord.wordType !== WordType.Verb">
                        <div class="options">
                            <button *ngFor="let option of currentWord.options" class="option-btn" [class.selected]="selectedOption === option" (click)="selectOption(option)">{{ option }}</button>
                        </div>
                    </ng-container>
                </div>

                <ng-template #standardQuestion>
                    <div class="i-know-btn-container">
                        <button id="i-know-btn" class="btn btn-success" (click)="iKnowThisWord()">Ich weiß es!</button>
                    </div>
                    <h2>
                        <!-- Display article for Noun -->
                        <ng-container *ngIf="currentWord.wordType === WordType.Noun && currentWord.article !== ArticleType.None">
                            {{ currentWord.article }}
                        </ng-container>
                        <!-- Always display originalWord -->
                        {{ currentWord.originalWord }}
                        <!-- Display for Verbs -->
                        <ng-container *ngIf="currentWord.wordType === WordType.Verb">
                            <ng-container *ngIf="currentWord.reflexive">
                                sich
                            </ng-container>
                            <ng-container *ngIf="currentWord.preposition">
                                {{ currentWord.preposition }}
                            </ng-container>
                            <ng-container *ngIf="currentWord.kasus && currentWord.kasus !== Kasus.None">
                                [{{ currentWord.kasus }}]
                            </ng-container>
                        </ng-container>
                    </h2>
                    <!-- Options for levels 0-2 (original word shown, guess translation) -->
                    <div class="options">
                        <button *ngFor="let option of currentWord.options" class="option-btn" [class.selected]="selectedOption === option" (click)="selectOption(option)">{{ option }}</button>
                    </div>
                </ng-template>

                <div class="learn-status">
                    <span>Learn Process:</span>
                    <div class="learn-status-bar">
                        <div class="learn-status-progress" [style.width.%]="(currentWord.learnStatus || 0) / 7 * 100"></div>
                    </div>
                    <span>{{ (currentWord.learnStatus || 0) / 7 * 100 | number:'1.0-0' }}%</span>
                </div>

                <p class="description" *ngIf="showDescription">{{ currentWord.description }}</p>
                <button class="toggle-description quiz-toggle-btn" (click)="toggleDescription()">{{ showDescription ? '-' : '+' }}</button>

                <div class="solution" *ngIf="currentWord.answer === false">
                    Correct Answer: {{ currentWord.correctAnswerDisplay }}
                </div>

                <div class="quiz-navigation">
                    <button id="next-btn" class="btn btn-primary" (click)="next()">{{ currentWord.answer === null ? 'Submit Answer' : 'Next Question' }}</button>
                </div>
                <div class="quiz-progress">
                    Question {{ quizService.session.currentIndex + 1 }} of {{ quizService.session.totalQuestions }}
                </div>
            </ng-container>
        </div>
    </div>
    <div class="card quiz-results" *ngIf="results">
        <h2>Quiz Complete!</h2>
        <p>Your score: {{ results.score }} / {{ results.totalQuestions }} ({{ results.percentage }}%)</p>
        <p>Time spent: {{ results.timeSpent | number:'1.2-2' }} seconds</p>
        <button id="reset-quiz" class="btn btn-primary" (click)="startQuiz()">Start New Quiz</button>
    </div>
</section>